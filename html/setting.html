<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>Hello MUI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="../css/mui.min.css">
		<style>
			html,
			body {
				background-color: #efeff4;
			}
			
			.mui-views,
			.mui-view,
			.mui-pages,
			.mui-page,
			.mui-page-content {
				position: absolute;
				left: 0;
				right: 0;
				top: 0;
				bottom: 0;
				width: 100%;
				height: 100%;
				background-color: #efeff4;
			}
			
			.mui-pages {
				top: 46px;
				height: auto;
			}
			
			.mui-scroll-wrapper,
			.mui-scroll {
				background-color: #efeff4;
			}
			
			.mui-page.mui-transitioning {
				-webkit-transition: -webkit-transform 300ms ease;
				transition: transform 300ms ease;
			}
			
			.mui-page-left {
				-webkit-transform: translate3d(0, 0, 0);
				transform: translate3d(0, 0, 0);
			}
			
			.mui-ios .mui-page-left {
				-webkit-transform: translate3d(-20%, 0, 0);
				transform: translate3d(-20%, 0, 0);
			}
			
			.mui-navbar {
				position: fixed;
				right: 0;
				left: 0;
				z-index: 10;
				height: 44px;
				background-color: #f7f7f8;
			}
			
			.mui-navbar .mui-bar {
				position: absolute;
				background: transparent;
				text-align: center;
			}
			
			.mui-android .mui-navbar-inner.mui-navbar-left {
				opacity: 0;
			}
			
			.mui-ios .mui-navbar-left .mui-left,
			.mui-ios .mui-navbar-left .mui-center,
			.mui-ios .mui-navbar-left .mui-right {
				opacity: 0;
			}
			
			.mui-navbar .mui-btn-nav {
				-webkit-transition: none;
				transition: none;
				-webkit-transition-duration: .0s;
				transition-duration: .0s;
			}
			
			.mui-navbar .mui-bar .mui-title {
				display: inline-block;
				width: auto;
			}
			
			.mui-page-shadow {
				position: absolute;
				right: 100%;
				top: 0;
				width: 16px;
				height: 100%;
				z-index: -1;
				content: '';
			}
			
			.mui-page-shadow {
				background: -webkit-linear-gradient(left, rgba(0, 0, 0, 0) 0, rgba(0, 0, 0, 0) 10%, rgba(0, 0, 0, .01) 50%, rgba(0, 0, 0, .2) 100%);
				background: linear-gradient(to right, rgba(0, 0, 0, 0) 0, rgba(0, 0, 0, 0) 10%, rgba(0, 0, 0, .01) 50%, rgba(0, 0, 0, .2) 100%);
			}
			
			.mui-navbar-inner.mui-transitioning,
			.mui-navbar-inner .mui-transitioning {
				-webkit-transition: opacity 300ms ease, -webkit-transform 300ms ease;
				transition: opacity 300ms ease, transform 300ms ease;
			}
			
			.mui-page {
				display: none;
			}
			
			.mui-pages .mui-page {
				display: block;
			}
			
			.mui-page .mui-table-view:first-child {
				margin-top: 15px;
			}
			
			.mui-page .mui-table-view:last-child {
				margin-bottom: 30px;
			}
			
			.mui-table-view {
				margin-top: 20px;
			}
			
			.mui-table-view span.mui-pull-right {
				color: #999;
			}
			
			.mui-table-view-divider {
				background-color: #efeff4;
				font-size: 14px;
			}
			
			.mui-table-view-divider:before,
			.mui-table-view-divider:after {
				height: 0;
			}
			
			.head {
				height: 40px;
			}
			
			#head {
				line-height: 40px;
			}
			
			.head-img {
				width: 40px;
				height: 40px;
			}
			
			#head-img1 {
				position: absolute;
				bottom: 10px;
				right: 40px;
				width: 40px;
				height: 40px;
			}
			
			.update {
				font-style: normal;
				color: #999999;
				margin-right: -25px;
				font-size: 15px
			}
			
			.mui-fullscreen {
				position: fixed;
				z-index: 20;
				background-color: #000;
			}
			
			.mui-ios .mui-navbar .mui-bar .mui-title {
				position: static;
			}
			/*问题反馈在setting页面单独的css*/
			
			#feedback .mui-popover {
				position: fixed;
			}
			
			#feedback .mui-table-view:last-child {
				margin-bottom: 0px;
			}
			
			#feedback .mui-table-view:first-child {
				margin-top: 0px;
			}
			
			.mui-plus.mui-plus-stream .mui-stream-hidden {
				display: none !important;
			}
			/*问题反馈在setting页面单独的css==end*/
			
			.x-header-right {
				line-height: 44px;
				float: right;
				margin-right: 10px;
			}
			
			.textRight {
				margin-right: 20px;
			}
		</style>
		<link rel="stylesheet" type="text/css" href="../css/feedback.css" />

	</head>

	<body class="mui-fullscreen">
		<!--页面主结构开始-->
		<div id="app" class="mui-views">
			<div class="mui-view">
				<div class="mui-navbar">
				</div>
				<div class="mui-pages">
				</div>
			</div>
		</div>
		<!--页面主结构结束-->
		<!--单页面开始-->
		<div id="setting" class="mui-page">
			<!--页面标题栏开始-->
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>
				</button>
				<h1 class="mui-center mui-title">设置</h1>
			</div>
			<!--页面标题栏结束-->
			<!--页面主内容区开始-->
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<ul class="mui-table-view mui-table-view-chevron">
							<li class="mui-table-view-cell mui-media">
								<a class="mui-navigate-right" href="#account">
									<span class="mui-media-object mui-pull-left head-img" id="head-img" style="background-size: cover;"></span>
									<!--<img class="mui-media-object mui-pull-left head-img" id="head-img" src="">-->
									<div class="mui-media-body">
										Hello
										<p class='mui-ellipsis'>账号:<span id='showAccount0'></span></p>
									</div>
								</a>
							</li>
						</ul>
						<ul class="mui-table-view mui-table-view-chevron">
							<li class="mui-table-view-cell">
								<a href="#account" class="mui-navigate-right">账号与安全</a>
							</li>
						</ul>

						<ul class="mui-table-view mui-table-view-chevron" style='display: none;'>
							<li class="mui-table-view-cell">
								<a href="#about" class="mui-navigate-right">关于盖饭 <i class="mui-pull-right update">V1.1.0</i></a>
							</li>
						</ul>

						<ul class="mui-table-view" id='offAccount'>
							<li class="mui-table-view-cell" style="text-align: center;">
								<a>退出登录</a>
							</li>
						</ul>
					</div>
				</div>
			</div>
			<!--页面主内容区结束-->
		</div>
		<!--单页面结束-->
		<div id="account" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>设置
				</button>
				<h1 class="mui-center mui-title">账号与安全</h1>
			</div>
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<ul class="mui-table-view">
							<li class="mui-table-view-cell">
								<a id="head" class="mui-navigate-right">头像
									<span class="mui-pull-right head">
									<span id="head-img1" class="mui-action-preview" ></span>
									<!--<img class="head-img mui-action-preview" id="head-img1" src=""/>-->
									</span>
								</a>
							</li>
							<li class="mui-table-view-cell">
								<a href="#updateNiceName" class="mui-navigate-right">昵称<span class="mui-pull-right textRight" id='showNiceName'></span></a>
							</li>
							<li class="mui-table-view-cell">
								<a href="#updateAccount" class="mui-navigate-right">账号<span class="mui-pull-right textRight" id='showAccount'></span></a>
							</li>
						</ul>
						<ul class="mui-table-view">
							<!--<li class="mui-table-view-cell">
								<a>QQ号<span class="mui-pull-right" id="showQQ"></span></a>
							</li>-->
							<li class="mui-table-view-cell">
								<a href='#updatePhone' class="mui-navigate-right">手机号<span class="mui-pull-right textRight" id="showPhone"></span></a>
							</li>
							<li class="mui-table-view-cell">
								<a href="#updateEmail" class="mui-navigate-right">邮箱地址<span class="mui-pull-right textRight" id='showEmail'></span></a>
							</li>
							<li class="mui-table-view-cell">
								<a href="#updatePwd" class="mui-navigate-right">密码<span class="mui-pull-right textRight" id='showPwd'></span></a>
							</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		<!--修改昵称单页面-->
		<div id="updateNiceName" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>设置
				</button>
				<span class="x-header-right" id='niceNameComplete'>完成</span>
				<h1 class="mui-center mui-title">修改昵称</h1>
			</div>
			<div class="mui-page-content">
				<input type="text" placeholder="请输入新昵称" id='niceNameValue' />
				<span></span>
			</div>
		</div>

		<!--end-->

		<!--修改密码单页面-->
		<div id="updatePwd" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>设置
				</button>
				<span class="x-header-right" id='pwdComplete'>完成</span>
				<h1 class="mui-center mui-title">设置密码</h1>
			</div>
			<div class="mui-page-content">
				<input type="text" placeholder="请输入当前的密码" id='pwdValue0' style='display: none;' />
				<span></span>
				<input type="text" placeholder="请输入新密码" id='pwdValue' />
				<span></span>
				<input type="text" placeholder="请再次输入新密码" id='pwdValue2' />
				<span id='pwd2info'></span>
			</div>
		</div>
		<!--end-->

		<!--修改账号单页面-->
		<div id="updateAccount" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>设置
				</button>
				<span class="x-header-right" id='accountComplete'>完成</span>
				<h1 class="mui-center mui-title">修改账号</h1>
			</div>
			<div class="mui-page-content">
				<input type="text" placeholder="请输入新账号" id='accountValue' />
				<span></span>
			</div>
		</div>
		<!--end-->

		<!--修改手机号单页面-->
		<div id="updatePhone" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>设置
				</button>
				<!--<span class="x-header-right" id='phoneComplete'>完成</span>-->
				<h1 class="mui-center mui-title">修改手机号</h1>
			</div>
			<div class="mui-page-content">
				<div id="hasPhone" style="display: none;">
					<span>修改手机号需要解除绑定原来的手机号</span><br/>
					<span>点击发送验证码，验证码将发送至</span><span id="oldPhone">234556454</span>
					<div style="position: relative;">
						<input type="text" placeholder="请输入验证码" id='hascodeValue' />
						<span id='hasSend' style='position: absolute;top:10%;right:0;background-color: #ccc;padding: 5px;border-radius: 5px;margin-right: 10px;'>发送验证码</span>
					</div>

					<span id='hasValid' style='display: block;background-color: #ccc;padding: 5px 10px;width: 80%;text-align: center;margin-left: 10%;'>确认</span>
				</div>
				<br />
				<div id='noHasPhone' style="display: none;">
					<span>请输入新手机号：</span>
					<input type="text" placeholder="请输入新手机号" id='phoneValue' />
					<div style='position: relative;'>
						<input type="text" placeholder="请输入验证码" id='codeValue' />
						<span id='noHasSend' style='position: absolute;top:10%;right:0;background-color: #ccc;padding: 5px;border-radius: 5px;margin-right: 10px;'>发送验证码</span>
					</div>
					<span id='noHasValid' style='display: block;background-color: #ccc;padding: 5px 10px;width: 80%;text-align: center;margin-left: 10%;'>确认</span>
				</div>
			</div>
		</div>
		<!--end-->

		<!--修改邮箱单页面-->
		<div id="updateEmail" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>设置
				</button>
				<span class="x-header-right" id='emailComplete'>完成</span>
				<h1 class="mui-center mui-title">修改邮箱</h1>
			</div>
			<div class="mui-page-content">
				<input type="text" placeholder="请输入新邮箱" id='emailValue' />
				<span></span>
			</div>
		</div>
		<!--end-->

		<div id="about" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>设置
				</button>
				<h1 class="mui-center mui-title">关于MUI</h1>
			</div>
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<ul class="mui-table-view">
							<li class="mui-table-view-cell mui-plus-visible mui-stream-hidden">
								<a id="rate" class="mui-navigate-right">评分鼓励</a>
							</li>
							<li class="mui-table-view-cell mui-plus-visible">
								<a id="welcome" class="mui-navigate-right">欢迎页</a>
							</li>
							<li class="mui-table-view-cell mui-plus-visible">
								<a id="share" class="mui-navigate-right">分享推荐</a>
							</li>
							<li class="mui-table-view-cell">
								<a id="tel" class="mui-navigate-right">客服电话</a>
							</li>
							<li class="mui-table-view-cell">
								<a id="feedback-btn" href="#feedback" class="mui-navigate-right">问题反馈</a>
							</li>
							<li id="check_update" class="mui-table-view-cell mui-plus-visible">
								<a id="update" class="mui-navigate-right">检查更新</a>
							</li>
						</ul>
					</div>
				</div>
			</div>
		</div>

		<div id="feedback" class="mui-page feedback">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>
				</button>
				<button id="submit" class="mui-btn mui-btn-blue mui-btn-link mui-pull-right">发送</button>
				<h1 class="mui-center mui-title">问题反馈</h1>
			</div>
			<div class="mui-page-content">
				<div class="mui-content-padded">
					<div class="mui-inline">问题和意见</div>
					<a class="mui-pull-right mui-inline" href="#popover">
						快捷输入
						<span class="mui-icon mui-icon-arrowdown"></span>
					</a>
					<!--快捷输入具体内容，开发者可自己替换常用语-->
					<div id="popover" class="mui-popover">
						<div class="mui-popover-arrow"></div>
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<ul class="mui-table-view">
									<!--仅流应用环境下显示-->
									<li class="mui-table-view-cell stream">
										<a href="#">桌面快捷方式创建失败</a>
									</li>
									<li class="mui-table-view-cell">
										<a href="#">界面显示错乱</a>
									</li>
									<li class="mui-table-view-cell">
										<a href="#">启动缓慢，卡出翔了</a>
									</li>
									<li class="mui-table-view-cell">
										<a href="#">偶发性崩溃</a>
									</li>
									<li class="mui-table-view-cell">
										<a href="#">UI无法直视，丑哭了</a>
									</li>
								</ul>
							</div>
						</div>
					</div>
				</div>
				<div class="row mui-input-row">
					<textarea id='question' class="mui-input-clear question" placeholder="请详细描述你的问题和意见..."></textarea>
				</div>
				<p>图片(选填,提供问题截图,总大小10M以下)</p>
				<div id='image-list' class="row image-list"></div>
				<p>QQ/邮箱</p>
				<div class="mui-input-row">
					<input id='contact' type="text" class="mui-input-clear contact" placeholder="(选填,方便我们联系你 )" />
				</div>
				<div class="mui-content-padded">
					<div class="mui-inline" id='test'>应用评分</div>
					<div class="icons mui-inline" style="margin-left: 6px;">
						<i data-index="1" class="mui-icon mui-icon-star"></i>
						<i data-index="2" class="mui-icon mui-icon-star"></i>
						<i data-index="3" class="mui-icon mui-icon-star"></i>
						<i data-index="4" class="mui-icon mui-icon-star"></i>
						<i data-index="5" class="mui-icon mui-icon-star"></i>
					</div>
				</div><br />
			</div>
		</div>

	</body>

	<script src="../js/mui.js"></script>
	<script src="../js/mui.view.js"></script>
	<script src='../js/feedback.js'></script>
	<script type="text/javascript" src="../js/jquery-3.3.1.min.js"></script>
	<script src='../js/tools.js'></script>
	<script src='../js/myApp.js'></script>

	<script>
		mui.init({
			beforeback: function() {
				//获得列表界面的webview
				var wsMy = plus.webview.getWebviewById('html/main-my.html');
				var home = plus.webview.getWebviewById('html/main-home.html');
				//触发列表界面的自定义事件（refresh）,从而进行数据刷新
				mui.fire(wsMy, 'defaultImg');
				mui.fire(home, 'niceName');
				//返回true，继续页面关闭逻辑
				return true;
			}
		});
		//初始化单页view
		var viewApi = mui('#app').view({
			defaultPage: '#setting'
		});
		//初始化单页的区域滚动
		mui('.mui-scroll-wrapper').scroll();

		showNiceName();
		showAccount();
		showEmail();
		showPhoneNumber();
		showPwd();

		var userinfo = app.getUserinfo();
		for(var key in userinfo) {
			console.log(key + "==" + userinfo[key]);
		}

		//如果有手机号就显示  "hasPhone" div块
		if(userinfo.phoneNumber) {
			document.getElementById("hasPhone").style.display = 'block';
			document.getElementById("oldPhone").innerText = userinfo.phoneNumber;

			document.getElementById("hasSend").addEventListener('tap', function() {
				//向已有的手机号发送验证码
				app.hasSend(function(data) {
					if(data) {
						console.log("验证码发送成功");
					}
				});
			});

			document.getElementById("hasValid").addEventListener('tap', function() {
				//已有手机号码  验证验证码
				app.hasValid(document.getElementById("hascodeValue").value, function(data) {
					if(data) {
						console.log("验证码正确");
						//显示  'noHasPhone' div块  
						document.getElementById("noHasPhone").style.display = 'block';
						document.getElementById("hasPhone").style.display = 'none';
					}
				});
			});

			//新手机号 发送验证码
			document.getElementById("noHasSend").addEventListener('tap', function() {
				var phone = document.getElementById("phoneValue").value;
				app.newPhoneSend(phone, function(data) {
					if(data) {
						console.log("验证码发送成功");
						//效验验证码
						document.getElementById("noHasValid").addEventListener('tap', function() {
							var code = document.getElementById("codeValue").value;
							app.newPoneValid(phone, code, function(data) {
								if(data) {
									console.log('验证成功');
									//修改手机号
									app.phoneNumberRest(code, phone, function(data) {
										if(data) {
											mui.toast('修改成功')
											showPhoneNumber();
											mui.back();
										}
									});
								}
							});
						});
					}
				});
			});

		} else { //否则，直接显示'noHasPhone' div块  
			document.getElementById("noHasPhone").style.display = 'block';
			document.getElementById("hasPhone").style.display = 'none';

			//【手机号未绑定情况】 新手机号 发送验证码
			document.getElementById("noHasSend").addEventListener('tap', function() {
				var phone = document.getElementById("phoneValue").value;
				app.noHasSend(phone, function(data) {
					if(data) {
						console.log("验证码发送成功");
						//效验验证码
						document.getElementById("noHasValid").addEventListener('tap', function() {
							var code = document.getElementById("codeValue").value;
							app.noHasValid(phone, code, function(data) {
								if(data) {
									console.log('验证成功');
									app.phoneNumber(code, phone, function(data) {
										mui.toast('修改成功')
										showPhoneNumber();
										mui.back();
									});
								}
							});
						});
					}
				});
			});

		}

		//显示用户信息检查
		function showCurrency(data, el) {
			if(data == null || data == '' || data == 'undefined') {
				el.innerHTML = '<span style="color:red;font-size: 14px;">未设置</span>';
				app.log(el.getAttribute('id') == 'showPwd');
			} else if(el.getAttribute('id') == 'showPwd') {
				el.innerText = "已设置";
			} else {
				el.innerText = data;
			}
		}

		//显示用户昵称
		function showNiceName() {
			var data = app.getUserinfo().niceName;
			app.log("显示用户昵称" + data);
			var niceName = document.getElementById('showNiceName');
			showCurrency(data, niceName);
		}

		//显示用户账号
		function showAccount() {
			var data = app.getUserinfo().username;
			var account = document.getElementById('showAccount');
			var account0 = document.getElementById('showAccount0');
			showCurrency(data, account);
			showCurrency(data, account0);
		}

		//显示用户手机号码
		function showPhoneNumber() {
			var data = app.getUserinfo().phoneNumber;
			var phone = document.getElementById("showPhone");
			showCurrency(data, phone);
		}

		//显示用户邮箱
		function showEmail() {
			var data = app.getUserinfo().email;
			var email = document.getElementById("showEmail");
			showCurrency(data, email);
		}

		//显示密码,为保证安全，如有密码，只显示“已设置”
		function showPwd() {
			var data = app.getUserinfo().password;
			console.log("pwd:" + data);
			var pwd = document.getElementById("showPwd");
			showCurrency(data, pwd);
		}

		/*
		 * 确认修改
		 * obj 文本框对象
		 * callback 执行的是哪个修改操作
		 */
		var confirmUpdate = function(obj, callback) {
			//检查格式	
			var info = obj.nextElementSibling;
			var id = obj.getAttribute('id');
			//非空验证
			if(app.strtrim(obj.value) == '') {
				info.innerHTML = '<span style="color:red">提示：不能为空</span>';
				obj.value = '';
				return false;
			}

			//正则
			var regEmail = new RegExp("^[a-z0-9]+([._\\-]*[a-z0-9])*@([a-z0-9]+[-a-z0-9]*[a-z0-9]+.){1,63}[a-z0-9]+$"); //邮箱正则表达式
			var regPhone = new RegExp('^1(3[0-9]|4[57]|5[0-35-9]|8[0-9]|70)\\d{8}$');
			var regAccount = new RegExp('^[A-Za-z_][A-Za-z_0-9]{4,35}$');
			var regPwd = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[^]{6,36}$/;
			switch(id) {
				case 'emailValue':
					if(!regEmail.test(obj.value)) {
						info.innerHTML = '<span style="color:red">提示：邮箱格式不对</span>';
						return false;
					}
					break;
				case 'noHasPhone':
					if(!regPhone.test(obj.value)) {
						info.innerHTML = '<span style="color:red">提示：手机格式不对</span>';
						return false;
					}
					break;

				case 'accountValue':
					if(!regAccount.test(obj.value)) {
						info.innerHTML = '<span style="color:red">提示：用户名 : 由字母数字下划线组成且开头必须是字母，在5~36个字符之间</span>';
						return false;
					}
					break;
				case 'pwdValue':
					if(!regPwd.test(obj.value)) {
						console.log(obj.value);
						info.innerHTML = '<span style="color:red">提示：密码 : 必须包含大写字母,小写字母和数字的6-36个字符</span>';
						return false;
					}
					break;
				case 'pwdValue2':
					var pwd = document.getElementById("pwdValue");
					if(!obj.value == pwd.value) {
						console.log("no");
						info.innerHTML = '<span style="color:red">提示：两次密码输入不一致</span>';
						return false;
					} else {
						console.log("ok");
						info.innerHTML = '';
					}
					break;

				default:
					break;
			}
			//回调 请求服务器的函数
			callback(obj.value);
			//返回
			mui.back();
		}

		//修改昵称
		var updateNiceName = function(newName) {
			app.updateNiceName(newName, function(data) {
				if(data) {
					//更新用户新昵称到本地
					var userinfo = app.getUserinfo();
					app.log('nicename:' + userinfo.niceName);
					userinfo.niceName = newName;
					app.setUserinfo(userinfo);
					showNiceName(); //重新显示昵称	
				}
			});
		}

		//修改邮箱
		var updateEmail = function(newEmail) {
			app.updateEmail(newEmail, function(data) {
				if(data) {
					//更新用户新昵称到本地
					var userinfo = app.getUserinfo();
					userinfo.email = newEmail;
					app.setUserinfo(userinfo);
					showEmail(); //重新显示昵称						
				}
			});
		}
		//修改账号
		var updateUserName = function(newUserName) {
			app.updateUserName(newUserName, function(data) {
				if(data) {
					app.log(newUserName);
					//更新用户数据到本地
					var userinfo = app.getUserinfo();
					app.log('username:' + userinfo.username);
					userinfo.username = newUserName;
					app.setUserinfo(userinfo);
					app.log('username:' + userinfo.username);
					showAccount(); //重新显示昵称						
				}
			})
		}

		//修改密码
		var updatePwdNew = function(newPwd) {
			app.updatePwdNew(newPwd, function(data) {
				if(data) {
					//更新用户数据到本地
					var userinfo = app.getUserinfo();
					app.log('userPwd:' + userinfo.password);
					userinfo.password = newPwd;
					app.setUserinfo(userinfo);
					app.log('userPwd:' + userinfo.password);
					showPwd(); //重新显示 
					mui.back();
				}
			})
		}

		//修改密码，已存在密码情况
		var updatePwd = function(oldPwd, newPwd) {
			app.updatePwd(oldPwd, newPwd, function(data) {
				if(data) {
					//更新用户数据到本地
					var userinfo = app.getUserinfo();
					app.log('userPwd:' + userinfo.password);
					userinfo.password = newPwd;
					app.setUserinfo(userinfo);
					app.log('userPwd:' + userinfo.password);
					showPwd(); //重新显示 
					mui.back();
				}
			});
		}

		var inputValue;
		//修改昵称 完成 事件
		niceNameComplete = document.getElementById("niceNameComplete");
		niceNameComplete.addEventListener('tap', function() {
			var inputValue = document.getElementById("niceNameValue");
			confirmUpdate(inputValue, updateNiceName);

		});

		//修改账号 完成 事件
		accountComplete = document.getElementById("accountComplete");
		accountComplete.addEventListener('tap', function() {
			var inputValue = document.getElementById("accountValue");
			confirmUpdate(inputValue, updateUserName);
		});

		var pwd = document.getElementById("pwdValue");
		pwd.addEventListener('blur', function() {
			var regPwd = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[^]{6,36}$/;
			if(!regPwd.test(this.value)) {
				this.nextElementSibling.innerHTML = '<span style="color:red">提示：密码 : 必须包含大写字母,小写字母和数字的6-36个字符</span>';
				return false;
			} else {
				this.nextElementSibling.innerHTML = '<span></span>';
			}
		});

		//		var pwd2=document.getElementById("pwdValue2");
		//		pwd2.addEventListener('blur',function(){
		//			if(this.value!=pwd.value){
		//				this.nextElementSibling.innerHTML='<span style="color:red>两次密码输入不一致</span>';
		//				return false;
		//			}
		//		});

		app.log("pwd...:" + app.getUserinfo().password);
		var statepwd = app.getUserinfo().password;
		app.log(!(statepwd == undefined || statepwd == null || statepwd == ''))
		if(!(statepwd == undefined || statepwd == null || statepwd == '')) {
			var pwdValue0 = document.getElementById("pwdValue0");
			pwdValue0.style.display = 'block';
			pwdValue0.addEventListener('blur', function() {
				var regPwd = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[^]{6,36}$/;
				if(!regPwd.test(this.value)) {
					this.nextElementSibling.innerHTML = '<span style="color:red">提示：密码 : 必须包含大写字母,小写字母和数字的6-36个字符</span>';
					return false;
				} else {
					this.nextElementSibling.innerHTML = '<span></span>';
				}
			});

			//修改密码 完成 事件,已存在密码情况
			pwdComplete = document.getElementById("pwdComplete");
			pwdComplete.addEventListener('tap', function() {
				var pwd2 = document.getElementById("pwdValue2");
				if(pwd2.value != pwd.value) {
					console.log(pwd2.value + "----" + pwd.value);
					document.getElementById("pwd2info").innerHTML = '<span style="color:red">两次密码输入不一致</span>';
					//				alert("两次密码输入不一致");
					return false;
				} else {
					updatePwd(pwdValue0.value, pwd2.value);
					showPwd();
				}

			});
		} else {
			//修改密码 完成 事件
			pwdComplete = document.getElementById("pwdComplete");
			pwdComplete.addEventListener('tap', function() {
				var pwd2 = document.getElementById("pwdValue2");
				if(pwd2.value != pwd.value) {
					console.log(pwd2.value + "----" + pwd.value);
					document.getElementById("pwd2info").innerHTML = '<span style="color:red">两次密码输入不一致</span>';
					//				alert("两次密码输入不一致");
					return false;
				} else {
					updatePwdNew(pwd2.value);
					showPwd();
				}

			});
		}

		//修改手机 完成 事件
		//		completeBtn = document.getElementById("phoneComplete");
		//		completeBtn.addEventListener('tap', function() {
		//			var inputValue = document.getElementById("phoneValue");
		//		});

		//修改邮箱 完成 事件
		emailComplete = document.getElementById("emailComplete");
		emailComplete.addEventListener('tap', function() {
			var inputValue = document.getElementById("emailValue");
			confirmUpdate(inputValue, updateEmail);
		});

		//注销
		var offAccount = document.getElementById("offAccount");
		offAccount.addEventListener('tap', function() {
			
			//保存auth信息
			app.setAuthinfo(null);
			//保存 state 信息
			var state = app.getState();
			state.account = null;
			state.token = null;
			app.setState(state);
			setTimeout(function() {
//				plus.runtime.quit();
				plus.webview.currentWebview().close();
			}, 1000);

			//			plus.webview.open('../loginPhoneNumber.html', 'index', {}, 'zoom-out', 500, function() {
			//				mui.toast('已退出')
			//			});

			mui.openWindow({
				url: "../loginPhoneNumber.html",
				id: 'loginPhoneNumber',
				styles: {
					statusbar: {
						background: '#6b6b83'
					},
					bounce: 'all'
				}
			});
			
//			plus.webview.getWebviewById('loginPhoneNumber').show();
			
		});

		//分享操作
		var shares = {};

		mui.plusReady(function() {
			plus.share.getServices(function(s) {
				if(s && s.length > 0) {
					for(var i = 0; i < s.length; i++) {
						var t = s[i];
						shares[t.id] = t;
					}
				}
			}, function() {
				console.log("获取分享服务列表失败");
			});
		});

		setTimeout(function() {
			defaultImg();
			//			setTimeout(function() {
			//				initImgPreview();
			//			}, 300);
		}, 500);

		//分享链接点击事件
		document.getElementById("share").addEventListener('tap', function() {
			var ids = [{
					id: "weixin",
					ex: "WXSceneSession"
				}, {
					id: "weixin",
					ex: "WXSceneTimeline"
				}, {
					id: "sinaweibo"
				}, {
					id: "tencentweibo"
				}, {
					id: "qq"
				}],
				bts = [{
					title: "发送给微信好友"
				}, {
					title: "分享到微信朋友圈"
				}, {
					title: "分享到新浪微博"
				}, {
					title: "分享到腾讯微博"
				}, {
					title: "分享到QQ"
				}];
			plus.nativeUI.actionSheet({
				cancel: "取消",
				buttons: bts
			}, function(e) {
				var i = e.index;
				if(i > 0) {
					var s_id = ids[i - 1].id;
					var share = shares[s_id];
					if(share) {
						if(share.authenticated) {
							shareMessage(share, ids[i - 1].ex);
						} else {
							share.authorize(function() {
								shareMessage(share, ids[i - 1].ex);
							}, function(e) {
								console.log("认证授权失败：" + e.code + " - " + e.message);
							});
						}
					} else {
						mui.toast("无法获取分享服务，请检查manifest.json中分享插件参数配置，并重新打包")
					}
				}
			});
		});

		function shareMessage(share, ex) {
			var msg = {
				extra: {
					scene: ex
				}
			};
			msg.href = "http://www.dcloud.io/hellomui/";
			msg.title = "最接近原生APP体验的高性能前端框架";
			msg.content = "我正在体验HelloMUI，果然很流畅，基本看不出和原生App的差距";
			if(~share.id.indexOf('weibo')) {
				msg.content += "；体验地址：http://www.dcloud.io/hellomui/";
			}
			msg.thumbs = ["_www/images/logo.png"];
			share.send(msg, function() {
				console.log("分享到\"" + share.description + "\"成功！ ");
			}, function(e) {
				console.log("分享到\"" + share.description + "\"失败: " + e.code + " - " + e.message);
			});
		}
		//去评分
		document.getElementById("rate").addEventListener('tap', function() {
			if(mui.os.ios) {
				location.href = 'https://itunes.apple.com/cn/app/hello-mui/id907931805?l=en&mt=8';
			} else if(mui.os.android) {
				plus.runtime.openURL("market://details?id=io.dcloud.HelloMUI", function(e) {
					plus.runtime.openURL("market://details?id=io.dcloud.HelloMUI", function(e) {
						mui.alert("360手机助手和应用宝，你一个都没装，暂时无法评分，感谢支持");
					}, "com.qihoo.appstore");
				}, "com.tencent.android.qqdownloader");
			}
		});
		//客服电话
		document.getElementById("tel").addEventListener('tap', function() {
			if(mui.os.plus) {
				plus.device.dial("114");
			} else {
				location.href = 'tel:114';
			}

		});
		//检查更新
		document.getElementById("update").addEventListener('tap', function() {
			var server = "http://www.dcloud.io/check/update"; //获取升级描述文件服务器地址
			mui.getJSON(server, {
				"appid": plus.runtime.appid,
				"version": plus.runtime.version,
				"imei": plus.device.imei
			}, function(data) {
				if(data.status) {
					plus.ui.confirm(data.note, function(i) {
						if(0 == i) {
							plus.runtime.openURL(data.url);
						}
					}, data.title, ["立即更新", "取　　消"]);
				} else {
					mui.toast('已是最新版本~')
				}
			});
		});
		var view = viewApi.view;
		(function($) {
			//处理view的后退与webview后退
			var oldBack = $.back;
			$.back = function() {
				if(viewApi.canBack()) { //如果view可以后退，则执行view的后退
					viewApi.back();
				} else { //执行webview后退
					oldBack();
				}
			};
			//监听页面切换事件方案1,通过view元素监听所有页面切换事件，目前提供pageBeforeShow|pageShow|pageBeforeBack|pageBack四种事件(before事件为动画开始前触发)
			//第一个参数为事件名称，第二个参数为事件回调，其中e.detail.page为当前页面的html对象
			view.addEventListener('pageBeforeShow', function(e) {
				//				console.log(e.detail.page.id + ' beforeShow');
			});
			view.addEventListener('pageShow', function(e) {
				//				console.log(e.detail.page.id + ' show');
			});
			view.addEventListener('pageBeforeBack', function(e) {
				//				console.log(e.detail.page.id + ' beforeBack');
			});
			view.addEventListener('pageBack', function(e) {
				//				console.log(e.detail.page.id + ' back');
			});
		})(mui);
		//更换头像
		mui(".mui-table-view-cell").on("tap", "#head", function(e) {
			if(mui.os.plus) {
				var a = [{
					title: "拍照"
				}, {
					title: "从手机相册选择"
				}];
				plus.nativeUI.actionSheet({
					title: "修改头像",
					cancel: "取消",
					buttons: a
				}, function(b) {
					switch(b.index) {
						case 0:
							break;
						case 1:
							getImage();
							break;
						case 2:
							galleryImg();
							break;
						default:
							break
					}
				})
			}

		});

		var avatar = app.getUserinfo().avatar;

		function getImage() {
			var c = plus.camera.getCamera();
			c.captureImage(function(e) {
				console.log("eeeee:" + e);
				app.appendFile(e);
				plus.io.resolveLocalFileSystemURL(e, function(entry) {
					//					var s = entry.toLocalURL() + "?version=" + new Date().getTime();
					//					console.log(s);
					//					//					document.getElementById("head-img").src = s;
					//					//					document.getElementById("head-img1").setAttribute('style', 'background-image: url(' + s + ');');
					//					document.getElementById("head-img").setAttribute('style', 'background-image: url(' + s + ');background-size: cover;background-position: center;');
					//					document.getElementById("head-img1").setAttribute('style', 'background-image: url(' + s + ');background-size: cover;background-position: center;');
					//					//变更大图预览的src
					//					//目前仅有一张图片，暂时如此处理，后续需要通过标准组件实现
					//					//					document.querySelector("#__mui-imageview__group .mui-slider-item img").src = s + "?version=" + new Date().getTime();;;
					app.upload(function(data) {
						if(data) {
							var userinfo = app.getUserinfo();
							userinfo.avatar = data;
							app.setUserinfo(userinfo);
							app.updateHeadImg(data, function(data) {
								if(data) {
									document.getElementById("head-img").setAttribute('style', 'background-image: url(' + app.getUserinfo().avatar + ');background-size: cover;background-position: center;');
									document.getElementById("head-img1").setAttribute('style', 'background-image: url(' + app.getUserinfo().avatar + ');background-size: cover;background-position: center;');
								}
							});
						}
					});
				}, function(e) {
					console.log("读取拍照文件错误：" + e.message);
				});
			}, function(s) {
				console.log("error" + s);
			}, {
				filename: "_doc/head.jpg"
			})
		}

		function galleryImg() {
			plus.gallery.pick(function(a) {
				app.log("a:" + a);
				app.appendFile(a);
				plus.io.resolveLocalFileSystemURL(a, function(entry) {
					plus.io.resolveLocalFileSystemURL("_doc/", function(root) {
						root.getFile("head.jpg", {}, function(file) {
							//文件已存在
							file.remove(function() {
								console.log("file remove success");
								entry.copyTo(root, 'head.jpg', function(e) {
										var e = e.fullPath + "?version=" + new Date().getTime();
										app.upload(function(data) {
											if(data) {
												var userinfo = app.getUserinfo();
												userinfo.avatar = data;
												app.setUserinfo(userinfo);
												app.updateHeadImg(data, function(data) {
													if(data) {
														document.getElementById("head-img").setAttribute('style', 'background-image: url(' + app.getUserinfo().avatar + ');background-size: cover;background-position: center;');
														document.getElementById("head-img1").setAttribute('style', 'background-image: url(' + app.getUserinfo().avatar + ');background-size: cover;background-position: center;');
													}
												});
											}
										});
									},
									function(e) {
										console.log('copy image fail:' + e.message);
									});
							}, function() {
								console.log("delete image fail:" + e.message);
							});
						}, function() {
							//文件不存在
							entry.copyTo(root, 'head.jpg', function(e) {
									var path = e.fullPath + "?version=" + new Date().getTime();
									document.getElementById("head-img").src = path;
									document.getElementById("head-img1").src = path;
									//变更大图预览的src
									//目前仅有一张图片，暂时如此处理，后续需要通过标准组件实现
									//									document.querySelector("#__mui-imageview__group .mui-slider-item img").src = path;
								},
								function(e) {
									console.log('copy image fail:' + e.message);
								});
						});
					}, function(e) {
						console.log("get _www folder fail");
					})
				}, function(e) {
					console.log("读取拍照文件错误：" + e.message);
				});
			}, function(a) {}, {
				filter: "image"
			})
		};

		function defaultImg() {
			//				if(mui.os.plus) {
			//					plus.io.resolveLocalFileSystemURL("_doc/head.jpg", function(entry) {
			//						var s = entry.fullPath + "?version=" + new Date().getTime();
			//						document.getElementById("img-account").setAttribute('style', 'background-image: url(' + s + ');background-size: cover;background-position: center;');
			//					}, function(e) {
			//						document.getElementById("img-account").setAttribute('style', 'background-image: url(' + s + ');background-size: cover;background-position: center;');
			//					})
			//				} else {
			//					document.getElementById("img-account").setAttribute('style', 'background-image: url(' + s + ');background-size: cover;background-position: center;');
			//				}

			var avatar = app.getUserinfo().avatar;
			if(avatar == null || avatar == undefined || avatar == '') {
				document.getElementById("head-img").setAttribute('style', 'background-image: url("../images/my.png");background-size: cover;background-position: center;');
				document.getElementById("head-img1").setAttribute('style', 'background-image: url("../images/my.png");background-size: cover;background-position: center;');
			} else {
				document.getElementById("head-img").setAttribute('style', 'background-image: url(' + avatar + ');background-size: cover;background-position: center;');
				document.getElementById("head-img1").setAttribute('style', 'background-image: url(' + avatar + ');background-size: cover;background-position: center;');
			}
		}

		document.getElementById("head-img1").addEventListener('tap', function(e) {
			//获取路径
			var attr = this.getAttribute('style');
			var i = attr.indexOf('background-image:');
			var y = attr.indexOf(';');
			str = attr.substring(i, y); //得到  background-image:xxx  ，再此基础之上再的到路径

			var x = str.indexOf(':');
			var xx = str.substring(x + 1);

			var d = xx.indexOf(')');

			var u = xx.substring(5, d);

			//阻止事件冒泡
			e.stopPropagation();
		});
		document.getElementById("welcome").addEventListener('tap', function(e) {
			//显示启动导航
			mui.openWindow({
				id: 'guide',
				url: 'guide.html',
				show: {
					aniShow: 'fade-in',
					duration: 300
				},
				waiting: {
					autoShow: false
				}
			});
		});

		function initImgPreview() {
			var imgs = document.querySelectorAll("img.mui-action-preview");
			imgs = mui.slice.call(imgs);
			if(imgs && imgs.length > 0) {
				var slider = document.createElement("div");
				slider.setAttribute("id", "__mui-imageview__");
				slider.classList.add("mui-slider");
				slider.classList.add("mui-fullscreen");
				slider.style.display = "none";
				slider.addEventListener("tap", function() {
					slider.style.display = "none";
				});
				slider.addEventListener("touchmove", function(event) {
					event.preventDefault();
				})
				var slider_group = document.createElement("div");
				slider_group.setAttribute("id", "__mui-imageview__group");
				slider_group.classList.add("mui-slider-group");
				imgs.forEach(function(value, index, array) {
					//给图片添加点击事件，触发预览显示；
					value.addEventListener('tap', function() {
						slider.style.display = "block";
						_slider.refresh();
						_slider.gotoItem(index, 0);
					})
					var item = document.createElement("div");
					item.classList.add("mui-slider-item");
					var a = document.createElement("a");
					var img = document.createElement("img");
					img.setAttribute("src", value.src);
					a.appendChild(img)
					item.appendChild(a);
					slider_group.appendChild(item);
				});
				slider.appendChild(slider_group);
				document.body.appendChild(slider);
				var _slider = mui(slider).slider();
			}
		}

		if(mui.os.stream) {
			document.getElementById("check_update").display = "none";
		}
	</script>

</html>